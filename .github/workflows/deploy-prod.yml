name: Deploy to Production

# Trigger on push to main branch
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20'
  FIREBASE_PROJECT: smartfleet-pro-prod

jobs:
  # ============================================
  # Job 1: Lint Code
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: firebase/functions/package-lock.json

      - name: Install dependencies
        working-directory: ./firebase/functions
        run: npm ci

      - name: Run ESLint
        working-directory: ./firebase/functions
        run: npm run lint

  # ============================================
  # Job 2: Test Firestore Rules
  # ============================================
  test-rules:
    name: Test Firestore Rules
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: firebase/package-lock.json

      - name: Install Firebase dependencies
        working-directory: ./firebase
        run: npm ci

      - name: Install Java (for Firestore emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Firebase emulators
        uses: actions/cache@v3
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Run Firestore Rules Tests
        working-directory: ./firebase
        run: npx firebase emulators:exec --only firestore "npm test"

  # ============================================
  # Job 3: Run Unit Tests
  # ============================================
  test-functions:
    name: Test Cloud Functions
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: firebase/functions/package-lock.json

      - name: Install dependencies
        working-directory: ./firebase/functions
        run: npm ci

      # Uncomment when unit tests are implemented
      # - name: Run Unit Tests
      #   working-directory: ./firebase/functions
      #   run: npm test

  # ============================================
  # Job 4: Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        working-directory: ./firebase/functions
        run: |
          npm audit --audit-level=moderate || true
          echo "‚ö†Ô∏è  Review security vulnerabilities before production deploy"

      # Optional: Use Snyk for advanced security scanning
      # - name: Run Snyk Security Scan
      #   uses: snyk/actions/node@master
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #   with:
      #     args: --severity-threshold=high

  # ============================================
  # Job 5: Build Functions
  # ============================================
  build:
    name: Build TypeScript
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: firebase/functions/package-lock.json

      - name: Install dependencies
        working-directory: ./firebase/functions
        run: npm ci

      - name: Build TypeScript
        working-directory: ./firebase/functions
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: firebase/functions/lib
          retention-days: 30

  # ============================================
  # Job 6: Deploy to Firebase Production (REQUIRES MANUAL APPROVAL)
  # ============================================
  deploy:
    name: Deploy to Firebase Production
    runs-on: ubuntu-latest
    needs: [test-rules, test-functions, security-scan, build]
    environment:
      name: production
      url: https://smartfleet-pro.web.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: firebase/functions/lib

      - name: Install Firebase dependencies
        working-directory: ./firebase/functions
        run: npm ci --production

      - name: Create Backup Point
        run: |
          echo "üì¶ Creating deployment backup point..."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}
          projectId: ${{ env.FIREBASE_PROJECT }}
          channelId: live
          
      - name: Deploy Firestore Rules & Indexes
        working-directory: ./firebase
        run: |
          npm install -g firebase-tools
          firebase deploy --only firestore:rules,firestore:indexes --project ${{ env.FIREBASE_PROJECT }} --token ${{ secrets.FIREBASE_TOKEN_PROD }}

      - name: Deploy Cloud Functions
        working-directory: ./firebase
        run: |
          firebase deploy --only functions --project ${{ env.FIREBASE_PROJECT }} --token ${{ secrets.FIREBASE_TOKEN_PROD }}

      - name: Health Check
        run: |
          echo "üîç Running production health checks..."
          sleep 15
          
          # Check main site
          curl -f https://smartfleet-pro.web.app || exit 1
          
          # Check Firebase project status
          echo "‚úÖ Production deployment verified!"

      - name: Run Smoke Tests
        run: |
          echo "üß™ Running production smoke tests..."
          # Add critical path smoke tests here
          echo "‚úÖ Smoke tests passed!"

      - name: Performance Check
        run: |
          echo "‚ö° Checking production performance..."
          # Add performance validation here
          echo "‚úÖ Performance metrics within acceptable range"

  # ============================================
  # Job 7: Rollback on Failure
  # ============================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Trigger Rollback
        run: |
          echo "üö® DEPLOYMENT FAILED - INITIATING ROLLBACK"
          echo "‚è™ Manual rollback required"
          echo "üìù Check Firebase Console for previous version"
          exit 1

  # ============================================
  # Job 8: Post-Deploy Notification & Documentation
  # ============================================
  notify:
    name: Post-Deploy Actions
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Create Deployment Record
        run: |
          echo "üìã PRODUCTION DEPLOYMENT RECORD"
          echo "================================"
          echo "Status: ${{ needs.deploy.result }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "URL: https://smartfleet-pro.web.app"
          echo "================================"

      - name: Notify Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL!"
            echo ""
            echo "üåê Production URL: https://smartfleet-pro.web.app"
            echo "üìä Firebase Console: https://console.firebase.google.com/project/smartfleet-pro-prod"
            echo "üìù Deployed by: ${{ github.actor }}"
            echo "üîñ Commit: ${{ github.sha }}"
            echo ""
            echo "‚ö†Ô∏è  IMPORTANT: Monitor production metrics for next 30 minutes"
          else
            echo "‚ùå PRODUCTION DEPLOYMENT FAILED!"
            echo ""
            echo "üö® CRITICAL: Production deployment failure detected"
            echo "üë§ Failed deployment by: ${{ github.actor }}"
            echo "üîñ Failed commit: ${{ github.sha }}"
            echo ""
            echo "üîß ACTION REQUIRED:"
            echo "   1. Check deployment logs above"
            echo "   2. Verify Firebase Console status"
            echo "   3. Consider rollback if necessary"
            echo "   4. Notify team immediately"
          fi
      
      # Uncomment to send Slack notification
      # - name: Slack Notification - Success
      #   if: needs.deploy.result == 'success'
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: custom
      #     custom_payload: |
      #       {
      #         "text": "üöÄ PRODUCTION DEPLOYMENT SUCCESSFUL",
      #         "attachments": [{
      #           "color": "good",
      #           "fields": [
      #             { "title": "Environment", "value": "Production", "short": true },
      #             { "title": "Deployed by", "value": "${{ github.actor }}", "short": true },
      #             { "title": "Commit", "value": "${{ github.sha }}", "short": true },
      #             { "title": "URL", "value": "https://smartfleet-pro.web.app", "short": false }
      #           ]
      #         }]
      #       }
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      
      # - name: Slack Notification - Failure
      #   if: needs.deploy.result != 'success'
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: custom
      #     custom_payload: |
      #       {
      #         "text": "üö® PRODUCTION DEPLOYMENT FAILED",
      #         "attachments": [{
      #           "color": "danger",
      #           "fields": [
      #             { "title": "Environment", "value": "Production", "short": true },
      #             { "title": "Failed by", "value": "${{ github.actor }}", "short": true },
      #             { "title": "Commit", "value": "${{ github.sha }}", "short": true },
      #             { "title": "Action", "value": "Manual intervention required", "short": false }
      #           ]
      #         }]
      #       }
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # Job 9: Tag Release
  # ============================================
  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release Tag
        run: |
          TAG="v$(date -u +"%Y.%m.%d-%H%M")"
          git tag -a "$TAG" -m "Production release $TAG"
          echo "Created tag: $TAG"
          # Push tag (requires write permissions)
          # git push origin "$TAG"
